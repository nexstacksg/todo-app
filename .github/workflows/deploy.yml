name: Deploy Todo App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via Proxmox
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'DEPLOY'
            # Execute commands in container 126
            pct exec 126 -- bash -c '
              set -e
              export PATH="/usr/local/bin:$PATH"
              cd /opt/todo-app
              
              echo "=== Pulling latest code ==="
              git fetch origin main
              git reset --hard origin/main
              
              echo "=== Installing dependencies ==="
              pnpm install --frozen-lockfile || pnpm install
              
              echo "=== Building ==="
              pnpm build || echo "Build step skipped"
              
              echo "=== Restarting services ==="
              pm2 restart all
              
              echo "=== Status ==="
              pm2 status
            '
          DEPLOY

      - name: Health Check
        run: |
          sleep 5
          STATUS=$(curl -sf https://todo-api.singaporetestlab.com/health | jq -r '.status')
          if [ "$STATUS" = "ok" ]; then
            echo "✅ Deployment successful! API is healthy."
          else
            echo "❌ Health check failed"
            exit 1
          fi
