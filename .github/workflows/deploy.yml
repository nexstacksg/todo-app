name: Deploy Todo App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via Proxmox
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'DEPLOY'
            pct exec 126 -- bash -c '
              set -e
              export PATH="/usr/local/bin:$PATH"
              cd /opt/todo-app
              
              echo "=== Pulling latest code ==="
              git fetch origin main
              git reset --hard origin/main
              
              echo "=== Installing dependencies ==="
              pnpm install --frozen-lockfile || pnpm install
              
              echo "=== Building API ==="
              # API uses tsx, no build needed
              
              echo "=== Building Web ==="
              cd apps/web && pnpm build && cd ../..
              
              echo "=== Restarting services ==="
              pm2 restart all
              pm2 save
              
              echo "=== Status ==="
              pm2 status
            '
          DEPLOY

      - name: Health Check
        run: |
          sleep 10
          echo "Checking API..."
          API_STATUS=$(curl -sf https://todo-api.singaporetestlab.com/health | jq -r '.status')
          echo "API status: $API_STATUS"
          
          echo "Checking Web..."
          WEB_CODE=$(curl -sf -o /dev/null -w "%{http_code}" https://todo.singaporetestlab.com)
          echo "Web status: $WEB_CODE"
          
          if [ "$API_STATUS" = "ok" ] && [ "$WEB_CODE" = "200" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Health check failed"
            exit 1
          fi
